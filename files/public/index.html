<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Remote Backup</title>
<style>
  :root{--bg:#111216;--panel:#1b1d23;--border:#2a2d35;--text:#e9eaee;--muted:#9aa0aa;--accent:#6ea8fe;--warn:#f0ad4e;--danger:#ff6b6b;--ok:#6ee7a8}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:980px;margin:0 auto;padding:18px}
  .hdr{display:flex;align-items:center;gap:10px;margin-bottom:14px}
  .badge{padding:4px 8px;border:1px solid var(--border);border-radius:999px;background:var(--panel);color:var(--muted)}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px;margin:12px 0;box-shadow:0 2px 10px rgba(0,0,0,.25)}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  button{padding:8px 12px;border:1px solid var(--border);border-radius:8px;background:#232630;color:var(--text);cursor:pointer}
  button:hover{border-color:#3a4353}
  .btn-accent{background:linear-gradient(180deg,#2a66ff,#244ee6);border:none}
  .btn-warn{background:#3b2f16;border:1px solid #8a6d3b;color:#f5d08a}
  .btn-danger{background:#3b1b1b;border:1px solid #8a3b3b;color:#ff9b9b}
  .status{margin-top:10px;color:var(--muted)}
  .status.ok{color:var(--ok)} .status.err{color:var(--danger)}
  .tr{display:grid;grid-template-columns:1fr 110px 140px;gap:10px;align-items:center;background:#191b22;border:1px solid var(--border);border-radius:10px;padding:10px;margin:8px 0}
  .name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .size{color:var(--muted)}
  .actions{display:flex;gap:8px;justify-content:flex-end}
</style>
</head>
<body>
  <div class="wrap">
    <div class="hdr">
      <h2 style="margin:0">Remote Backup</h2>
      <span class="badge">SFTP 微服务 · 端口 8787</span>
    </div>
    <div class="card">
      <div class="row">
        <button id="health">健康检查</button>
        <button class="btn-accent" id="backup">创建备份</button>
        <button id="refresh">刷新列表</button>
      </div>
      <div id="status" class="status">就绪（首次访问会弹出一次账号/密码）</div>
    </div>
    <div class="card">
      <div class="row"><h3 style="margin:0;font-size:16px">备份列表</h3></div>
      <div id="list" style="margin-top:8px"></div>
    </div>
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 style="margin:0;font-size:16px">日志</h3>
        <div style="display:flex;gap:8px">
          <button id="log-refresh">刷新</button>
          <button id="log-toggle">自动刷新: 开</button>
          <button id="log-clear" class="btn-danger">清空</button>
        </div>
      </div>
      <pre id="log-box" style="margin-top:8px;background:#0f1115;border:1px solid var(--border);border-radius:8px;padding:10px;max-height:45vh;overflow:auto;white-space:pre-wrap"></pre>
    </div>
  </div>
<script>
(function(){
  const $ = s => document.querySelector(s);
  const statusEl = $('#status');
  const listEl = $('#list');
  async function api(method, path){
    const res = await fetch(path, { method, headers:{'Content-Type':'application/json'} });
    const txt = await res.text();
    try{ return JSON.parse(txt); }catch{ return { ok:false, raw:txt }; }
  }
  function human(n){ return (n/1048576).toFixed(2)+' MB'; }
  function setStatus(msg, type){ statusEl.textContent = msg; statusEl.className = 'status' + (type ? ' '+type : ''); }
  async function health(){ setStatus('检查中...'); const r=await api('GET','/health'); setStatus(r.ok?`OK · dataDir=${r.dataDir} · backupDir=${r.backupDir}`:`失败: ${r.error||r.raw||''}`, r.ok?'ok':'err'); }
  async function backup(){ setStatus('备份中...（数据大时需等待）'); const r=await api('POST','/backup'); setStatus(r.ok?('备份完成: '+r.file):('失败: '+(r.error||r.raw||'')), r.ok?'ok':'err'); if(r.ok) refresh(); }
  function render(items){
    listEl.innerHTML=''; if(!items||!items.length){ listEl.innerHTML='<div class="status">暂无备份</div>'; return; }
    items.forEach(it=>{
      const row=document.createElement('div'); row.className='tr';
      row.innerHTML=`<div class="name" title="${it.name}">${it.name}</div><div class="size">${human(it.size)}</div>
        <div class="actions"><button class="btn-warn" data-act="restore">恢复</button><button class="btn-danger" data-act="delete">删除</button></div>`;
      row.querySelector('[data-act="restore"]').onclick=async()=>{ if(!confirm('确定恢复并覆盖 data/?'))return; setStatus('恢复中...'); const r=await api('POST','/restore?name='+encodeURIComponent(it.name)); setStatus(r.ok?'恢复完成':('恢复失败: '+(r.error||r.raw||'')), r.ok?'ok':'err'); };
      row.querySelector('[data-act="delete"]').onclick=async()=>{ if(!confirm('确定删除该备份?'))return; setStatus('删除中...'); const r=await api('DELETE','/delete?name='+encodeURIComponent(it.name)); setStatus(r.ok?'已删除':('删除失败: '+(r.error||r.raw||'')), r.ok?'ok':'err'); if(r.ok) refresh(); };
      listEl.appendChild(row);
    });
  }
  async function refresh(){ setStatus('加载列表...'); const r=await api('GET','/list'); if(!r.ok){ setStatus('失败: '+(r.error||r.raw||''),'err'); return; } setStatus(`共有 ${r.items?.length||0} 个备份`,'ok'); render(r.items); }
  $('#health').onclick=health; $('#backup').onclick=backup; $('#refresh').onclick=refresh;
  refresh().catch(()=>{});
  // 日志面板
  const logBox = document.getElementById('log-box');
  const btnLogRefresh = document.getElementById('log-refresh');
  const btnLogToggle = document.getElementById('log-toggle');
  const btnLogClear = document.getElementById('log-clear');
  let logAuto = true; let logTimer = null;
  async function loadLogs(){
    try { const r = await fetch('/logs?limit=500'); const j = await r.json();
      logBox.textContent = (j.lines||[]).join('\n'); logBox.scrollTop = logBox.scrollHeight; } catch(e) {}
  }
  function startLogAuto(){ if (logTimer) clearInterval(logTimer); logTimer = setInterval(()=>{ if (logAuto) loadLogs(); }, 2000); }
  btnLogRefresh?.addEventListener('click', loadLogs);
  btnLogToggle?.addEventListener('click', ()=>{ logAuto=!logAuto; btnLogToggle.textContent = `自动刷新: ${logAuto?'开':'关'}`; if (logAuto) loadLogs(); });
  btnLogClear?.addEventListener('click', async ()=>{ await fetch('/logs',{method:'DELETE'}); logBox.textContent=''; });
  loadLogs(); startLogAuto();
})();
</script>
</body>
</html>
